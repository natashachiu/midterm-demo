<%- include('partials/_header') %>

  <h1>
    <%= story.title %>
  </h1>

  <article>
    <p>
      <%= story.username %>
    </p>
    <p>
      <%= story.created_at %>
    </p>
  </article>

  <section>
    <h4>Story</h4>
    <div>
      <%= story.content %>
    </div>
  </section>

  <% if (userId===story.user_id) { %>
    <div>
      <form action="/story/<%= story.story_id %>/toggle" method="post">
      <label class="toggle-btn">
        <button type="submit" value="true" name="toggleButton">Complete</button>
      </label>
    </form>
      <h3>
        <%= story.completed_at ? 'Completed' : 'Not Complete' %>
      </h3>
    </div>
    <% } %>


      <section>
        <h3>Contributions</h3>

        <div class="container">
          <div class="row row-cols-lg-3 row-cols-md-3 row-cols-sm-1">

            <% for (const contribution of contributions) {%>
              <div class="col">
                <div class="card card-input text-center">
                  <div class="card-body pb-0">
                    <%= contribution.contribution_content %>
                  </div>

                  <div class="d-flex justify-content-end">
                    <% if (userId===story.user_id) { %>
                      <form action="/story/<%= story.story_id %>/append" method="post">
                        <button type="submit" class="btn btn-default" name="contribution"
                          value="<%= contribution.id %>">
                          <ion-icon name="add-outline"></ion-icon>
                        </button>
                      </form>
                      <% } %>

                        <% if (upvotedContributions.includes(contribution.id)) { %>
                          <form action="/story/<%= story.story_id %>/upvote/remove" method="post">
                            <button type="submit" class="btn btn-default" name="upvote" value="<%= contribution.id %>">
                              <ion-icon name="heart" class="active"></ion-icon>
                            </button>
                          </form>
                          <% } else { %>
                            <form action="/story/<%= story.story_id %>/upvote/add" method="post">
                              <button type="submit" class="btn btn-default" name="upvote"
                                value="<%= contribution.id %>">
                                <ion-icon name="heart"></ion-icon>
                              </button>
                            </form>
                            <% } %>

                              <span>
                                <%= contribution.up_vote %>
                              </span>
                  </div>
                </div>
              </div>
              <% } %>

          </div>
        </div>
      </section>


      <section>
        <h4>Add your own contribution</h4>
        <form action="/story/<%= story.story_id %>/contribute" method="post">
          <div>
            <textarea type="text" name="content"></textarea>
            <button type="submit">Publish</button>
          </div>
        </form>
      </section>


      <script>
        function handleToggle(storyId, user_id) {
          const toggleButton = document.getElementById('toggleButton');
          // Send an AJAX request to the server
          fetch("/story/<%= storyId %>/toggle", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
          })
            .then(response => {
              if (response.ok) {
                console.log('Story status updated.');
              } else {
                console.error('Failed to update story status.');
              }
            })
            .catch(error => {
              console.error('Error updating story status:', error);
            });
        }

      </script>
      </body>

      </html>